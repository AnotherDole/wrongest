<!DOCTYPE html>
<html>

<div id='startDiv'>
	<button id='pickCreate' onclick='showCreate();'>Create a room</button>
	<button id='pickJoin' onclick='showJoin();'>Join a room</button>
</div>

<div id = 'createDiv' style='display:none'>
	<h1>Create Room</h1>
	Name: <input type="text" id='createUsernameInput' maxlength="50">
	Room Name: <input type='text' id='createRoomNameInput' maxlength='50'>
	Password: <input type='text' id='createPasswordInput'>
	<button id='createroombutton' onclick='createroom();'>Create New Room</button>
	<button onclick="$('#createDiv').hide();$('#startDiv').show();">Back</button>
	<div id='createResult'></div>
</div>

<div id='joinDiv' style='display:none'>
	<h1>Join Room</h1>
	<select id='roomselector'>
	</select>

	Name: <input type='text' id='joinUsernameInput' maxlength='50'>
	Password: <input type="text" id='joinPasswordInput'>
	<button id='joinroombutton' onclick='joinroom();'>Join Selected Room</button>
	<button id='updaterooms' onclick='updaterooms();'>Update Room Selection</button>
	<button onclick="$('#joinDiv').hide();$('#startDiv').show();">Back</button>
	<div id='joinResult'></div>
</div>

<div id='roomDiv' style='display:none'>
	<div id='roommembers'>Not in a room yet.</div>
	<button id='leaveroom' onclick='leaveroom();'>Leave Current Room</button>
	<div id='leaderControls'>
		Deck: <select id='deck' onchange='updateDeckDescription();'></select>
		<div id='deckdescription'></div>
		Time Limit: 
		<select id='timeLimit'>
			<option value='30'>30 seconds</option>
			<option value='60'>60 seconds</option>
			<option value='90'>90 seconds</option>
		</select><br>
		Should players get the same card twice in a game?
		<select id='allowRedraw'>
			<option value='no'>No</option>
			<option value='yes'>Yes</option>
		</select><br>
		Does the dealer defend first or last?
		<select id='dealerSelect'>
			<option value='last'>Last</option>
			<option value='first'>First</option>
		</select><br>
		<button id='startgamebutton' onclick='startgame();'>Start Game</button>
		<div id='startresult'></div>
	</div>
</div>

<div id='timerDiv' style='display:none'>
	<div id='timeLeftDiv'>Time goes here.</div>
</div>

<div id='orderDiv' style='display:none'>
	<div id='player1' style='display:none'></div>
	<div id='player2' style='display:none'></div>
	<div id='player3' style='display:none'></div>
	<div id='player4' style='display:none'></div>
	<div id='player5' style='display:none'></div>
	<div id='player6' style='display:none'></div>
	<div id='player7' style='display:none'></div>
	<div id='player8' style='display:none'></div>
	<div id='dealerControls' style='display:none'>
		<button onclick='makeDefend();'>Deal a Card</button>
	</div>
</div>

<div id='defendDiv' style='display:none'>
	<h1>Defend this Statement</h1>
	<h2 id='statementDiv'></h2>
	<div id='authorDiv'></div>
	<div id='sourceDiv'></div>
	<div id='cardScoreDiv'></div>
	<br>
	<button onclick='donedefend()'>I'm done early.</button>
</div>

<div id='voteDiv' style='display:none'>
	Least Wrong: <select id='least'></select> Most Wrong: <select id='most'></select> 
	<button onclick='sendvotes();'>Send my votes.</button>
	<div id='voteResult'></div>
</div>

<div id='scoreDiv' style='display:none'>
	<div id='roundText'></div>
	<button onclick='$("#scoreDiv").hide();'>Got it, thanks.</button>
</div>

<script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script>
var socket;
if(location.hostname.indexOf('rhcloud.com') > -1){
	socket = io(location.hostname + ':8000');
}
else{
	socket = io();
}
var username = "";
var deckData;
var currentStatements;
var playerList;
var timeLeft;
var timerVar;
var meDefending = false;

function showCreate(){
	$('#startDiv').hide();
	$('#createDiv').show();
}

function showJoin(){
	$('#startDiv').hide();
	$('#joinDiv').show();
	updaterooms();
}

//received after creating or joining a room
socket.on('deckdata',function(data){
	deckData = data;
	$('#deck').empty();
	for(var deck in data){
		$('#deck').append($('<option/>', {text: deck, value: deck}));
	}
	updateDeckDescription();
});

function updateDeckDescription(){
	var theDeck = deckData[$('#deck').val()];
	$('#deckdescription').empty().append(theDeck.description + ' Cards: ' + theDeck.numCards);
}

//send username, room name, password 
function createroom(){
	socket.emit('createroom',$('#createUsernameInput').val(),
				$('#createRoomNameInput').val(),
				$('#createPasswordInput').val());
}

//received after emitting createroom
socket.on('createresult',function(data){
	if(data.success){
		$('#roomresult').text('Room created!');
		username = data.playerName;
		$('#createDiv').hide();
		$('#roomDiv').show();
		$('#startDiv').hide();
	}
	else{
		$('#createResult').text(data.message);
	}	
});

//Send request for information about all rooms
function updaterooms(){
	socket.emit('requestroomdata');
}

//recieved after emitting request for name and player count of all rooms
socket.on('roomdata',function(data){
	$('#roomselector').empty();
	for(var room in data){
		var name = data[room].name;
		var toAppend = '<option value="'+name+ '">' + name + ' (' + data[room].playerCount;
		toAppend = toAppend +'/8) </option>';
		$('#roomselector').append(toAppend);
	}
});


//send username, room name, password 
function joinroom(){
	socket.emit('requestjoin',$('#joinUsernameInput').val(),
			$('#roomselector').val(),
			$('#joinPasswordInput').val());
}

//received after emitting requestjoin
socket.on('joinresult',function(data){
	if(data.success){
		$('#roomresult').text('Successfully joined room');
		$('#joinDiv').hide();
		$('#roomDiv').show();
		$('#startDiv').hide();
		username = data.playerName;
	}
	else{
		$('#joinResult').text(data.message);
	}
});

//send request to leave current room. 
function leaveroom(){
	socket.emit('requestleave');
}	

//received after leaving a room
socket.on('leaveresult',function(data){
	username = false;
	$('#roommembers').empty();
	$('#roommembers').text('Not in a room yet');
	$('#roomDiv').hide();
	$('#orderDiv').hide();
	$('#statementsDiv').hide();
	$('#voteDiv').hide();
	$('#voteResult').hide();
	$('#startDiv').show();
});

//received whenever someone in the current room leaves or joins
socket.on('updatecurrentroom', function(data){
	var $toChange = $('#roommembers');
	$toChange.empty();
	playerList = data.players;

	$toChange.append('Currently in ' + data.roomName + ':<br>');
	for (var i = 0; i < data.players.length; i++){
		$toChange.append(data.players[i]);
		if(data.players[i] == data.leader){
			$toChange.append(" (leader)");
		}
		$toChange.append("<br>");
	}
	if(data.leader == username){
		$('#leaderControls').show();
	}
	else{
		$('#leaderControls').hide();
	}
});

//Request to start the game. Only works if you are the leader of the room
function startgame(){
	socket.emit('requeststart',$('#deck').val(),
		   		   $('#timeLimit').val(),
		   		   $('#allowRedraw').val(),
		   		   $('#dealerSelect').val());
}

socket.on('startresult', function(data){
	if(data.success){
		$('#startresult').text('Game Started');		
	}
	else{
		$('#startresult').text(data.message);
	}
});

//Receive the statments that everyone will be defending this round.
//Automatically sent out at the start of a new round
socket.on('getstatements', function(data){	
	$('#roomDiv').hide();
	$('#voteDiv').hide();
	$('#orderDiv').show();
	currentStatements = data;
});

//Received at the start of a round
//Includes the order for the current round and the dealer
socket.on('roundorder', function(list,dealer){
	if(dealer == username){
		$('#dealerControls').show();
	}
	else{
		$('#dealerControls').hide();
	}
	for (var i = 0; i < list.length; i++){
		var $theDiv = $('#player' + (i+1)).show();
		$theDiv.empty().append(list[i]);
		if(list[i] == dealer){
			$theDiv.append(' (dealer)');
		}
	}
	for(var i = list.length+1; i <= 8; i++){
		$('#player' + i).hide();
	}
});

function makeDefend(){
	socket.emit('makedefend');
}

socket.on('timetodefend',function(player,time){
	timeLeft = time;
	timerVar = window.setInterval(function() {timerFunction()},1000);
	if(player == username){
		meDefending = true;
		$('#defendDiv').show();
		$('#orderDiv').hide();
		var myStatement = currentStatements[username];
		$('#statementDiv').empty().text(myStatement.quote);
		$('#authorDiv').empty().text(myStatement.author);
		$('#sourceDiv').empty().text(myStatement.source);
		$('#cardScoreDiv').empty().text('Score: ' + myStatement.score);
	}	
	else{
		meDefending = false;
	}
	$('#timerDiv').show();
	$('#timeLeftDiv').text(time + ' seconds left.');
})

function timerFunction(){
	if(timeLeft > 0){
		timeLeft--;
	}
	$('#timeLeftDiv').text(timeLeft + ' seconds left.');
	if(timeLeft == 0 && meDefending){
		donedefend();
	}
}


//Tell server you are done defending your statement
function donedefend(){
	$('#defendDiv').hide();
	socket.emit('donedefending');
}

//received when anyone in the room says they are done defending
//data is the # of people who are not done
socket.on('newdefendcount',function(data){
	$('#timerDiv').hide();
	$('#orderDiv').show();
	window.clearInterval(timerVar);
	if(data > 0){
		var playersDone = playerList.length - data;
		for(var i = 1; i <= playersDone; i++){
			$('#player' + i).css('background-color','green');
		}
	}
	else{
		$('#orderDiv').hide();
		$('#voteDiv').show();
		$('#voteResult').empty();
		updateVoteSelectors();
	}
});

function updateVoteSelectors(){
	$mostSelect = $('#most').empty();
	$leastSelect = $('#least').empty();
	for(var i = 0; i < playerList.length; i++){
		if (playerList[i] == username) continue;
		var theStatement = currentStatements[playerList[i]];
		$mostSelect.append($('<option/>').val(playerList[i]).text(theStatement.quote));
		$leastSelect.append($('<option/>').val(playerList[i]).text(theStatement.quote));
	}
}

//received if your attempt to say you are done voting failed for some reason
socket.on('donefailed',function(data){
	$('#votestatus').text(data);
});

//send votes for most/least wrong
//most and least should be the name of the player
function sendvotes(){
	var mostWrong = $('#most').val();
	var leastWrong = $('#least').val();
	socket.emit('playervotes',mostWrong,leastWrong);
}

//received if the submitted votes were invalid
socket.on('votefailed', function(data){
	$('#voteResult').append(data + "<br>");	
});

//received when someone else in the same room has voted
socket.on('receivevote', function(data){
	$('#voteResult').show();
	var whoVoted = data.voter;
	var most = data.mostName;
	var least = data.leastName;
	$('#voteResult').append(whoVoted + " says that " + least + " is least wrong and " + most + " is most wrong.<br>");
});

//received at the end of a round
socket.on('roundend', function(data){
	$('#scoreDiv').show();
	var $resultDiv = $('#roundText');
	var gameData = data.gameData;
	var playerData = data.playerData;

	$resultDiv.empty();
	$resultDiv.append('<b>End of round ' + gameData.round + '</b>');
	for(var player in playerData){
		$resultDiv.append('<br>' + player + ' gains ' + playerData[player].scoreChange + ' points. Current Score: ' + playerData[player].newScore);
	}
	$resultDiv.append('<br>Cards left: ' + gameData.cardsLeft + '<br><b> Defend your next point. </b>');
	
	//reset player div colors
	for(var i = 1; i <= playerList.length; i++){
		$('#player' + i).css('background-color','white');
	}
});

socket.on('gameover', function(data){
	var $resultDiv = $('#voteResult');
	$resultDiv.empty().append('<b>Game Over!</b><br>');
	$resultDiv.append('Winner: ' + data.player + ' with a score of ' + data.playerScore + '.<br>');
	$resultDiv.append('Wrongest Words: ' + data.card + ' with a score of ' + data.cardScore);
});

</script>
</html>
