<!DOCTYPE html>
<html>
Name: <input type="text" id='usernameinput' maxlength="15"> <button onclick="sendusername();">Send Username</button>
<div id="logonresult">No result yet.</div>
<br>

<select id='roomselector'>
</select>

<input type="text" id='roomnamer' maxlength="15">
<input type="text" id='password' maxlength='15'>
<button id='createroombutton' onclick='createroom();'>Create New Room</button>
<button id='joinroombutton' onclick='joinroom();'>Join Selected Room</button>
<button id='updaterooms' onclick='updaterooms();'>Update Room Selection</button>
<button id='leaveroom' onclick='leaveroom();'>Leave Current Room</button>
<select id='deck' onchange='updateDeckDescription();'></select>
<div id='deckdescription'></div>
<div id='roomresult'>No result yet.</div>
<div id='roommembers'>Not in a room yet.</div>

<br><br>

<button id='startgamebutton' onclick='startgame();'>Start Game</button>
<div id='startresult'></div>

<h1>Defend this Statement:</h1>
<h2 id='statement'></h2>
<br>
<h1>Other players</h1>
<div id='statementsdiv'></div>
<br>
<button onclick='donedefend();'>I am done defending my point.</button>
<div id='votestatus'>It is not time to vote yet.</div>
Least Wrong: <select id='least'></select> Most Wrong: <select id='most'></select> 
<button onclick='sendvotes();'>Send my votes.</button>
<div id='voteresult'></div>

<script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
var socket;
if(location.hostname.indexOf('rhcloud.com') > -1){
	socket = io(location.hostname + ':8000');
}
else{
	socket = io();
}
var username = "";
var deckData;
var currentStatements;
var playerList;
var needUpdateDisplay;

//send username string
function sendusername(){
	socket.emit('logon', $('#usernameinput').val());
}

//received after emitting logon
socket.on('logonresult',function(data){
	if(data.success){
		$('#logonresult').text('Success!');
		username = data.name;
		updaterooms();
	}
	else{
		$('#logonresult').text(data.message);
	}
});

//received after logon
socket.on('deckdata',function(data){
	deckData = data;
	$('#deck').empty();
	for(var deck in data){
		$('#deck').append($('<option/>', {text: deck, value: deck}));
	}
	updateDeckDescription();
});

function updateDeckDescription(){
	var theDeck = deckData[$('#deck').val()];
	$('#deckdescription').empty().append(theDeck.description + ' Cards: ' + theDeck.numCards);
}

//send roomname string
function createroom(){
	socket.emit('createroom',$('#roomnamer').val(),$('#password').val());
}

//received after emitting createroom
socket.on('createresult',function(data){
	if(data.success){
		$('#roomresult').text('Room created!');
	}
	else{
		$('#roomresult').text(data.message);
	}	
});

//Send request for information about all rooms
function updaterooms(){
	socket.emit('requestroomdata');
}

//recieved after emitting request for name and player count of all rooms
socket.on('roomdata',function(data){
	$('#roomselector').empty();
	for(var room in data){
		var name = data[room].name;
		var toAppend = '<option value="'+name+ '">' + name + ' (' + data[room].playerCount;
		toAppend = toAppend +'/8) </option>';
		$('#roomselector').append(toAppend);
	}
});


//send name of room to join
function joinroom(){
	socket.emit('requestjoin',$('#roomselector').val(),$('#password').val());
}

//received after emitting requestjoin
socket.on('joinresult',function(data){
	if(data.success){
		$('#roomresult').text('Successfully joined room');
	}
	else{
		$('#roomresult').text(data.message);
	}
});

//send request to leave current room. 
function leaveroom(){
	socket.emit('requestleave');
}	

//received after leaving a room
socket.on('leaveresult',function(data){
	if(data.success){
		needUpdateDisplay = false;
		$('#roommembers').empty();
		$('#roommembers').text('Not in a room yet');
	}	
});

//received whenever someone in the current room leaves or joins
socket.on('updatecurrentroom', function(data){
	var $toChange = $('#roommembers');
	$toChange.empty();
	playerList = data.players;
	console.log(playerList);

	$toChange.append('Currently in ' + data.roomName + ':<br>');
	for (var i = 0; i < data.players.length; i++){
		$toChange.append(data.players[i]);
		if(data.players[i] == data.leader){
			$toChange.append(" (leader)");
		}
		$toChange.append("<br>");
	}
	if(needUpdateDisplay){
		updateDisplay();
	}
});

//Request to start the game. Only works if you are the leader of the room
function startgame(){
	socket.emit('requeststart',$('#deck').val());
}

socket.on('startresult', function(data){
	if(data.success){
		$('#startresult').text('Game Started');		
	}
	else{
		$('#startresult').text(data.message);
	}
});

function updateDisplay() {
	var $thediv = $('#statementsdiv').empty();
	var $leastselect = $('#least').empty();
	var $mostselect = $('#most').empty();
	for(var i = 0; i < playerList.length; i++){
		var player = playerList[i];
		var quote = currentStatements[player].quote;
		var author = currentStatements[player].author;
		var episode = currentStatements[player].episode;
		var score = currentStatements[player].score;
		if(player == username){
			$('#statement').empty().append(quote + '<br>Card Score:' + score);
		}
		else{
			$thediv.append(player + ': ' + quote + '<br>Card Score: ' + score + '<br>');
			$leastselect.append($('<option/>', {text: player, value: player}));
			$mostselect.append($('<option/>', {text: player, value: player}));
		}
	}
}

//Receive the statments that everyone will be defending this round.
//Automatically sent out at the start of a new round
socket.on('getstatements', function(data){	
	needUpdateDisplay = true;
	currentStatements = data;
	updateDisplay();
});

//Tell server you are done defending your statement
function donedefend(){
	socket.emit('donedefending');
}

//received when anyone in the room says they are done defending
//data is the # of people who are not done
socket.on('newdefendcount',function(data){
	if(data > 0){
		$('#votestatus').text('Dones needed to continue:' + data);	
	}
	else{
		$('#votestatus').text('Time to vote!');
		$('#voteresult').empty();
	}
});

//received if your attempt to say you are done voting failed for some reason
socket.on('donefailed',function(data){
	$('#votestatus').text(data);
});

//send votes for most/least wrong
//most and least should be the ID of the player
function sendvotes(){
	var mostWrong = $('#most').val();
	var leastWrong = $('#least').val();
	socket.emit('playervotes',{most: mostWrong, least: leastWrong});
}

//received if the submitted votes were invalid
socket.on('votefailed', function(data){
	$('#voteresult').append(data + "<br>");	
});

//received when someone else in the same room has voted
socket.on('receivevote', function(data){
	var whoVoted = data.voter;
	var most = data.mostName;
	var least = data.leastName;
	$('#voteresult').append(whoVoted + " says that " + least + " is least wrong and " + most + " is most wrong.<br>");
});

//received at the end of a round
socket.on('roundend', function(data){
	var gameData = data.gameData;
	var playerData = data.playerData;
	var $resultDiv = $('#voteresult');
	$resultDiv.append('<b>End of round ' + gameData.round + '</b>');
	for(var player in playerData){
		$resultDiv.append('<br>' + player + ' gains ' + playerData[player].scoreChange + ' points. Current Score: ' + playerData[player].newScore);
	}
	$resultDiv.append('<br>Cards left: ' + gameData.cardsLeft + '<br><b> Defend your next point. </b>');
});

socket.on('gameover', function(data){
	var $resultDiv = $('#voteresult');
	$resultDiv.empty().append('<b>Game Over!</b><br>');
	$resultDiv.append('Winner: ' + data.player + ' with a score of ' + data.playerScore + '.<br>');
	$resultDiv.append('Wrongest Words: ' + data.card + ' with a score of ' + data.cardScore);
});

</script>
</html>
