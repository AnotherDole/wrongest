<!DOCTYPE html>
<html>

<div id='startDiv'>
	<button id='pickCreate' onclick='showCreate();'>Create a room</button>
	<button id='pickJoin' onclick='showJoin();'>Join a room</button>
</div>

<div id = 'createDiv' style='display:none'>
	<h1>Create Room</h1>
	Name: <input type="text" id='createUsernameInput' maxlength="50">
	Room Name: <input type='text' id='createRoomNameInput' maxlength='50'>
	Password: <input type='text' id='createPasswordInput'>
	<button id='createroombutton' onclick='createroom();'>Create New Room</button>
	<button onclick="$('#createDiv').hide();$('#startDiv').show();">Back</button>
	<div id='createResult'></div>
</div>

<div id='joinDiv' style='display:none'>
	<h1>Join Room</h1>
	<select id='roomselector'>
	</select>

	Name: <input type='text' id='joinUsernameInput' maxlength='50'>
	Password: <input type="text" id='joinPasswordInput'>
	<button id='joinroombutton' onclick='joinroom();'>Join Selected Room</button>
	<button id='updaterooms' onclick='updaterooms();'>Update Room Selection</button>
	<button onclick="$('#joinDiv').hide();$('#startDiv').show();">Back</button>
	<div id='joinResult'></div>
</div>

<div id='roomDiv' style='display:none'>
	<div id='roommembers'>Not in a room yet.</div>
	<button id='leaveroom' onclick='leaveroom();'>Leave Current Room</button>
	<div id='leaderControls'>
		<select id='deck' onchange='updateDeckDescription();'></select>
		<div id='deckdescription'></div>
		<button id='startgamebutton' onclick='startgame();'>Start Game</button>
		<div id='startresult'></div>
	</div>
</div>

<div id='statementsDiv' style='display:none'>
	<h1>Defend this Statement:</h1>
	<h2 id='statement'></h2>
	<h1>Other players</h1>
	<div id='statementsdiv'></div>
	<br>
	<button onclick='donedefend();'>I am done defending my point.</button>
	<div id='votestatus'>It is not time to vote yet.</div>
</div>

<div id='voteDiv' style='display:none'>
	Least Wrong: <select id='least'></select> Most Wrong: <select id='most'></select> 
	<button onclick='sendvotes();'>Send my votes.</button>
	<div id='voteResult'></div>
</div>

<div id='roundDiv' style='display:none'>
	<div id='roundText'></div>
	<button onclick='$("#roundDiv").hide();'>Got it, thanks.</button>
</div>

<script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script>
var socket;
if(location.hostname.indexOf('rhcloud.com') > -1){
	socket = io(location.hostname + ':8000');
}
else{
	socket = io();
}
var username = "";
var deckData;
var currentStatements;
var playerList;
var needUpdateDisplay;

function showCreate(){
	$('#startDiv').hide();
	$('#createDiv').show();
}

function showJoin(){
	$('#startDiv').hide();
	$('#joinDiv').show();
	updaterooms();
}

//received after creating or joining a room
socket.on('deckdata',function(data){
	deckData = data;
	$('#deck').empty();
	for(var deck in data){
		$('#deck').append($('<option/>', {text: deck, value: deck}));
	}
	updateDeckDescription();
});

function updateDeckDescription(){
	var theDeck = deckData[$('#deck').val()];
	$('#deckdescription').empty().append(theDeck.description + ' Cards: ' + theDeck.numCards);
}

//send username, room name, password 
function createroom(){
	socket.emit('createroom',$('#createUsernameInput').val(),
				$('#createRoomNameInput').val(),
				$('#createPasswordInput').val());
}

//received after emitting createroom
socket.on('createresult',function(data){
	if(data.success){
		$('#roomresult').text('Room created!');
		username = data.playerName;
		$('#createDiv').hide();
		$('#roomDiv').show();
	}
	else{
		$('#createResult').text(data.message);
	}	
});

//Send request for information about all rooms
function updaterooms(){
	socket.emit('requestroomdata');
}

//recieved after emitting request for name and player count of all rooms
socket.on('roomdata',function(data){
	$('#roomselector').empty();
	for(var room in data){
		var name = data[room].name;
		var toAppend = '<option value="'+name+ '">' + name + ' (' + data[room].playerCount;
		toAppend = toAppend +'/8) </option>';
		$('#roomselector').append(toAppend);
	}
});


//send username, room name, password 
function joinroom(){
	socket.emit('requestjoin',$('#joinUsernameInput').val(),
			$('#roomselector').val(),
			$('#joinPasswordInput').val());
}

//received after emitting requestjoin
socket.on('joinresult',function(data){
	if(data.success){
		$('#roomresult').text('Successfully joined room');
		$('#joinDiv').hide();
		$('#roomDiv').show();
		username = data.playerName;
	}
	else{
		$('#roomresult').text(data.message);
	}
});

//send request to leave current room. 
function leaveroom(){
	socket.emit('requestleave');
}	

//received after leaving a room
socket.on('leaveresult',function(data){
	if(data.success){
		needUpdateDisplay = false;
		username = false;
		$('#roommembers').empty();
		$('#roommembers').text('Not in a room yet');
		$('#roomDiv').hide();
		$('#statementsDiv').hide();
		$('#voteDiv').hide();
		$('#voteResult').hide();
		$('#startDiv').show();
	}	
});

//received whenever someone in the current room leaves or joins
socket.on('updatecurrentroom', function(data){
	var $toChange = $('#roommembers');
	$toChange.empty();
	playerList = data.players;

	$toChange.append('Currently in ' + data.roomName + ':<br>');
	for (var i = 0; i < data.players.length; i++){
		$toChange.append(data.players[i]);
		if(data.players[i] == data.leader){
			$toChange.append(" (leader)");
		}
		$toChange.append("<br>");
	}
	if(data.leader == username){
		$('#leaderControls').show();
	}
	else{
		$('#leaderControls').hide();
	}
	if(needUpdateDisplay){
		updateDisplay();
	}
});

//Request to start the game. Only works if you are the leader of the room
function startgame(){
	socket.emit('requeststart',$('#deck').val());
}

socket.on('startresult', function(data){
	if(data.success){
		$('#startresult').text('Game Started');		
	}
	else{
		$('#startresult').text(data.message);
	}
});

function updateDisplay() {
	var $thediv = $('#statementsdiv').empty();
	var $leastselect = $('#least').empty();
	var $mostselect = $('#most').empty();
	for(var i = 0; i < playerList.length; i++){
		var player = playerList[i];
		var quote = currentStatements[player].quote;
		var author = currentStatements[player].author;
		var episode = currentStatements[player].episode;
		var score = currentStatements[player].score;
		if(player == username){
			$('#statement').empty().append(quote + '<br>Card Score:' + score);
		}
		else{
			$thediv.append(player + ': ' + quote + '<br>Card Score: ' + score + '<br>');
			$leastselect.append($('<option/>', {text: quote, value: player}));
			$mostselect.append($('<option/>', {text: quote, value: player}));
		}
	}
}

//Receive the statments that everyone will be defending this round.
//Automatically sent out at the start of a new round
socket.on('getstatements', function(data){	
	$('#roomDiv').hide();
	$('#voteDiv').hide();
	$('#statementsDiv').show();
	needUpdateDisplay = true;
	currentStatements = data;
	updateDisplay();
});

//Tell server you are done defending your statement
function donedefend(){
	socket.emit('donedefending');
}

//received when anyone in the room says they are done defending
//data is the # of people who are not done
socket.on('newdefendcount',function(data){
	if(data > 0){
		$('#votestatus').text('Dones needed to continue:' + data);	
	}
	else{
		$('#statementsDiv').hide();
		$('#voteDiv').show();
		$('#votestatus').text('Time to vote!');
		$('#voteResult').empty();
	}
});

//received if your attempt to say you are done voting failed for some reason
socket.on('donefailed',function(data){
	$('#votestatus').text(data);
});

//send votes for most/least wrong
//most and least should be the name of the player
function sendvotes(){
	var mostWrong = $('#most').val();
	var leastWrong = $('#least').val();
	socket.emit('playervotes',mostWrong,leastWrong);
}

//received if the submitted votes were invalid
socket.on('votefailed', function(data){
	$('#voteResult').append(data + "<br>");	
});

//received when someone else in the same room has voted
socket.on('receivevote', function(data){
	$('#voteResult').show();
	var whoVoted = data.voter;
	var most = data.mostName;
	var least = data.leastName;
	$('#voteResult').append(whoVoted + " says that " + least + " is least wrong and " + most + " is most wrong.<br>");
});

//received at the end of a round
socket.on('roundend', function(data){
	$('#roundDiv').show();
	var $resultDiv = $('#roundText');
	var gameData = data.gameData;
	var playerData = data.playerData;
	$resultDiv.empty();
	$resultDiv.append('<b>End of round ' + gameData.round + '</b>');
	for(var player in playerData){
		$resultDiv.append('<br>' + player + ' gains ' + playerData[player].scoreChange + ' points. Current Score: ' + playerData[player].newScore);
	}
	$resultDiv.append('<br>Cards left: ' + gameData.cardsLeft + '<br><b> Defend your next point. </b>');
});

socket.on('gameover', function(data){
	var $resultDiv = $('#voteResult');
	$resultDiv.empty().append('<b>Game Over!</b><br>');
	$resultDiv.append('Winner: ' + data.player + ' with a score of ' + data.playerScore + '.<br>');
	$resultDiv.append('Wrongest Words: ' + data.card + ' with a score of ' + data.cardScore);
});

</script>
</html>
