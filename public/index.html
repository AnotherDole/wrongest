<!DOCTYPE html>
<html>
  <title>The Wrongest Words v0.1</title>
  <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,100,700' rel='stylesheet' type='text/css'>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="css/wrongest.css" rel="stylesheet" />
  
  <body>
    
    <div id="NameDisplay"></div>

    <section id="PlayerSetup">
      <h1>The Wrongest Words</h1>
      <div id="NameSetup" class="slideblock rtl">
        <label class="name-label" for="usernameinput">Your name?</label>
        <div class="name-wrapper">
          <input class="name-input" type="text" id='usernameinput' maxlength="15">
          <button class="name-button" onclick="sendusername();"><i class="fa fa-check"></i></button>
        </div>
        <div id="logonresult"></div>
      </div>
      
      <div id="RoomSetup" class="slideblock rtl hidden">
        <dl class="room-choices">
          <dt>create</dt>
          <dd class="create-wrapper">
            <input type="text" class="create-input" id='roomnamer' maxlength="15" placeholder="Room Name">
            <button id='createroombutton' class="create-button" onclick='createroom();'><i class="fa fa-plus"></i></button>
          </dd>
          <dt>or join</dt>
          <dd class="join-wrapper">
            <select class="join-select" id='roomselector'>
            </select>
            <button class="join-button" id='joinroombutton' onclick='joinroom();'><i class="fa fa-check"></i></button>
            <button class="join-button" id='updaterooms' onclick='updaterooms();'><i class="fa fa-refresh"></i></button>
          </dd>
        </dl>
        <div id='roomresult'> </div>
        <!-- <div id='roommembers'> </div> -->
      </div>
    </section>
    
    <section id="GameScreen" class="below">
      <div id="PreGame" class="slideblock">
        <h3 id="RoomStatusHeadline"></h1>
        <ol id='roommembers'></ol>
        <button id="StartGameButton" id='startgamebutton' disabled onclick='startgame();'>Start Game</button>
        <div id='startresult'></div>
      </div>
      <div id="CardDisplay" class="slideblock hidden">
        <!-- <h3>Defend this Statement:</h1> -->
        <div class="flip-container">
          <div class="flipper">
            <div class="front">
              <div class="inner">
                <blockquote id="statement"></blockquote>
                <i class="fa fa-share fa-2x" onclick='donedefend();'></i>
              </div>
            </div>
            <div class="back">
              <div class="inner">
                <div id='votestatus'>It is not time to vote yet.</div>
              </div>
            </div>
          </div>
        </div>
        <!-- <button id="DoneDefendingButton" onclick='donedefend();'>I am done defending my point.</button> -->
      </div>
      <div id="VotingBooth" class="slideblock hidden">
        <div class="wrong-wrapper least-wrong">
          <div class="inner">
            <label for="least">Least Wrong</label>
            <select id='least'>
              <option value=""></option>
            </select>
          </div>
        </div>
        <div class="wrong-wrapper most-wrong">
          <div class="inner">
            <label for="most">Most Wrong</label>
            <select id='most'>
              <option value=""></option>
            </select> 
          </div>
        </div>
        <button id="SendVotes" onclick='sendvotes();'><i class="fa fa-check fa-2x"></i></button>
        <div id='voteresult' style="display:none;"></div>
      </div>
      
    </section>

    <script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script>
      var socket;
      if(location.hostname.indexOf('rhcloud.com') > -1){
	socket = io(location.hostname + ':8000');
      }
      else{
	socket = io();
      }
      var username = "";

      //send username string
      function sendusername(){
        socket.emit('logon', $('#usernameinput').val());
      }

      //received after emitting logon
      socket.on('logonresult',function(data){
        if(data.success){
          $('#NameSetup').addClass('hidden');
          $('#RoomSetup').removeClass('hidden');
          $('#RoomSetup').removeClass('hidden');
          username = data.name;
          $('#NameDisplay').text(data.name);
          updaterooms();
        }
        else{
          $('#logonresult').text(data.message);
        }
      });

      //send roomname string
      function createroom(){
        socket.emit('createroom',$('#roomnamer').val());
      }

      //received after emitting createroom
      socket.on('createresult',function(data){
        if(data.success){
          $('#roomresult').text('Room created!');
        }
        else{
          $('#roomresult').text(data.message);
        }	
      });

      //Send request for information about all rooms
      function updaterooms(){
        socket.emit('requestroomdata');
      }

      //recieved after emitting request for name and player count of all rooms
      socket.on('roomdata',function(data){
        $('#roomselector').empty();
        for(room in data){
          var name = data[room].name;
          var toAppend = '<option value="'+name+ '">' + name + ' (' + data[room].playerCount;
          toAppend = toAppend +'/8) </option>';
          $('#roomselector').append(toAppend);
        }
      });


      //send name of room to join
      function joinroom(){
        socket.emit('requestjoin',$('#roomselector').val());
      }

      //received after emitting requestjoin
      socket.on('joinresult',function(data){
        if(data.success){
          $('#roomresult').text('Successfully joined room');
        }
        else{
          $('#roomresult').text(data.message);
        }
      });

      //send request to leave current room. 
      function leaveroom(){
        socket.emit('requestleave');
      }	

      //received after leaving a room
      socket.on('leaveresult',function(data){
        if(data.success){
          $('#roommembers').empty();
          $('#roommembers').text('Not in a room yet');
        }	
      });

      //received whenever someone in the current room leaves or joins
      socket.on('updatecurrentroom', function(data){
        var $toChange = $('#roommembers');
        $toChange.empty();
        if (data.players.length > 2) {
          $('#StartGameButton').attr('disabled',false);
        } else {
          $('#StartGameButton').attr('disabled',true);
        }

        //$toChange.append('Currently in ' + data.roomName + ':<br>');
        $('#RoomStatusHeadline').text('Currently in '+data.roomName+':');
        $('#PlayerSetup').addClass('above');
        $('#GameScreen').removeClass('below').addClass('above');
        for (var i = 0; i < data.players.length; i++){
          
          if(data.players[i] == data.leader){
            $toChange.append('<li>'+data.players[i]+' (leader)</li>');
          } else {
            $toChange.append('<li>'+data.players[i]+'</li>');
          }
        }
      });

      //Request to start the game. Only works if you are the leader of the room
      function startgame(){
        socket.emit('requeststart','Mini Deck');
      }

      socket.on('startresult', function(data){
        if(data.success){
          $('#startresult').text('Game Started');
        }
        else{
          $('#startresult').text(data.message);
        }
      });
      
      $('select#least').change(function() {
        if ( $(this).val() == "" ) {
          $(this).parent('.inner').parent('.wrong-wrapper').removeClass('selected');
        } else {
          $(this).parent('.inner').parent('.wrong-wrapper').addClass('selected');
          if ( $(this).parent('.inner').parent('.wrong-wrapper').siblings('.most-wrong').hasClass('selected') ) {
            $('#SendVotes').addClass('visible');
          }
        }
      });
      $('select#most').change(function() {
        if ( $(this).val() == "" ) {
          $(this).parent('.inner').parent('.wrong-wrapper').removeClass('selected');
        } else {
          $(this).parent('.inner').parent('.wrong-wrapper').addClass('selected');
          if ( $(this).parent('.inner').parent('.wrong-wrapper').siblings('.least-wrong').hasClass('selected') ) {
            $('#SendVotes').addClass('visible');
          }
        }
      });

      //Receive the statments that everyone will be defending this round.
      //Automatically sent out at the start of a new round
      socket.on('getstatements', function(data){
        $('#PreGame').addClass('hidden');
        $('#CardDisplay').removeClass('hidden');
        var $thediv = $('#statementsdiv').empty();
        var $leastselect = $('#least').empty().append('<option val=""></option>');
        var $mostselect = $('#most').empty().append('<option val=""></option>');
        for(var player in data){
          var quote = data[player].quote;
          var author = data[player].author;
          var episode = data[player].episode;
          var score = data[player].score;
          if(player == username){
            $('#statement').empty().append(quote);
          }
          else{
            $thediv.append(player + ": " + quote + "<br>");
            $leastselect.append($('<option/>', {text: player, value: player}));
            $mostselect.append($('<option/>', {text: player, value: player}));
          }
        }	
      });

      //Tell server you are done defending your statement
      function donedefend(){
        $('.flip-container').toggleClass('hover');
        socket.emit('donedefending');
      }

      //received when anyone in the room says they are done defending
      //data is the # of people who are not done
      socket.on('newdefendcount',function(data){
        if(data > 0){
          $('#votestatus').text('Dones needed to continue:' + data);	
        }
        else{
          $('#votestatus').text('Time to vote!');
          $('#CardDisplay').addClass('hidden');
          $('#VotingBooth').removeClass('hidden');
          $('.wrong-wrapper').removeClass('selected');
          $('#SendVotes').removeClass('visible');
        }
      });

      //received if your attempt to say you are done voting failed for some reason
      socket.on('donefailed',function(data){
        $('#votestatus').text(data);
      });

      //send votes for most/least wrong
      //most and least should be the ID of the player
      function sendvotes(){
        var mostWrong = $('#most').val();
        var leastWrong = $('#least').val();
        socket.emit('playervotes',{most: mostWrong, least: leastWrong});
        $('#VotingBooth').addClass('hidden');
        $('.flip-container').removeClass('hover');
      }

      //received if the submitted votes were invalid
      socket.on('votefailed', function(data){
        $('#voteresult').append(data + "<br>");	
      });

      //received when someone else in the same room has voted
      socket.on('receivevote', function(data){
        var whoVoted = data.voter;
        var most = data.mostName;
        var least = data.leastName;
        $('#voteresult').append(whoVoted + " says that " + least + " is least wrong and " + most + " is most wrong.<br>");
      });
    </script>
  </body>
</html>
